"use strict";var e=require("fastify"),r=require("@fastify/cors"),t=require("@fastify/multipart"),s=require("@fastify/formbody");class o{static Success=e=>({response:e});static Error=e=>({error:e});static NotReady=this.Error({code:0,message:"The server is not ready yet. Try a little later"});static MethodIsNotDefined=this.Error({code:1,message:"Method is not defined"});static BadRequest=this.Error({code:2,message:"Bad Request"});static AccessDenied=this.Error({code:3,message:"Access Denied"});static ServerError=this.Error({code:4,message:"Attempt to connect to server failed"})}const i=e=>r=>e.header("content-type","application/json; charset=utf-8").code(200).send(r);exports.Request=o,exports.Server=class{secret;services;server=e();callback;constructor(e){this.secret=e.secret,this.services=e.services,this.server.register(r,{origin:"*"}),this.server.register(s),this.server.register(t,{attachFieldsToBody:!0,addToBody:!0}),this.server.route({url:"/",method:"POST",preHandler:this.preHandler,handler:this.handler})}preHandler=(e,r,t)=>{const s=i(r);try{const{authorization:r}=e.headers;if(!this.secret)return void t();if(!r||r!==this.secret)return void s(o.AccessDenied);t()}catch(e){console.error(e),s(o.BadRequest)}};handler=(e,r)=>{const t=i(r);try{if(!this.callback)return void t(o.NotReady);const{type:r,value:s}=e.body;if(!r||!s)return void t(o.BadRequest);const i=this.callback[r];if(!i&&"function"!=typeof i)return void t(o.MethodIsNotDefined);i(s,t)}catch(e){console.error(e),t(o.BadRequest)}};events=e=>{this.callback=e};listen=async(e=18400,r="0.0.0.0")=>{try{await this.server.listen({port:e,host:r});const t=this.server.server.address();t||(console.info("Server is not starting"),process.exit(1));const{address:s,port:o}="string"==typeof t?{address:r,port:e}:t;console.info(`[INFO] Listener port ${s}:${o}`)}catch(e){this.server.log.error(e),process.exit(1)}};send(e,r,t,s){const i=this.services[e];if(!i)return void console.warn(`[WARN] ${e.toString()} in not defined`);const c=`http://${i}/`,a={method:"POST",headers:{Authorization:this.secret,"Content-Type":"application/json"},body:JSON.stringify({type:r,value:t})};if(!s)return new Promise((async e=>{try{const r=await fetch(c,a),{error:t,response:s}=await r.json();t&&console.error(t),e([t,s])}catch{e([o.ServerError.error,void 0])}}));new Promise((async()=>{try{const e=await fetch(c,a),{error:r,response:t}=await e.json();r&&(console.error(r),s([r,void 0])),s([void 0,t])}catch{s([o.ServerError.error,void 0])}}))}};
